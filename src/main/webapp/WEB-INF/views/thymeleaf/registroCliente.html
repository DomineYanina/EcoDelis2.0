<!DOCTYPE html>
<html>
<head>
    <title>Registrate</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <script type="application/x-javascript"> addEventListener("load", function() { setTimeout(hideURLbar, 0); }, false); function hideURLbar(){ window.scrollTo(0,1); } </script>
    <!-- Custom Theme files -->
    <link rel="stylesheet" th:href="@{/css/registroCliente.css}" />
    <!-- //Custom Theme files -->
    <!-- web font -->
    <link href="//fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i" rel="stylesheet">
    <!-- //web font -->
</head>
<body>
<!-- main -->
<div class="main-w3layouts wrapper">
    <h1>Completa tus datos</h1>
    <div class="main-agileinfo">
        <div class="container">

            <div class="form-container informacion-container">
                <form th:object="${cliente}" th:action="@{/registrarCliente}" method="post">
                    <input th:field="*{nombre}" type="text" id="nombre" placeholder="Ingrese el nombre" required>
                    <input th:field="*{apellido}" type="text" id="apellido" placeholder="Ingrese el apellido" required>
                    <select th:field="*{tipodoc}" id="Tipo_doc" required>
                        <option value="" disabled selected>Seleccione la localidad</option>
                        <option th:each="tip : ${tiposDocumento}" th:value="${tip}" th:text="${tip}"></option>
                    </select>
                    <input th:field="*{nrodoc}" type="number" id="Nro_doc" placeholder="Ingrese el número de documento" required>
                    <select th:field="*{tipocliente}" id="Tipo_cliente" required>
                        <option value="" disabled selected>Seleccione el tipo de cliente</option>
                        <option th:each="tipo : ${TiposDeCliente}" th:value="${tipo}" th:text="${tipo}"></option>
                    </select>
                    <input th:field="*{fnac}" type="date" id="F_nac" required>
                    <div class="wthree-text">
                        <label class="anim">
                            <input type="checkbox" class="checkbox" required="">
                            <span>Acepto los términos y condiciones</span>
                        </label>
                        <div class="clear"> </div>
                    </div>
                    <input type="submit" value="SIGNUP">
                </form>
                <p>Ya tenés cuenta? <a href="#"> Inicia sesión!</a></p>
            </div>
            <div class="form-container direccion-container">
                <form th:object="${direccionCliente}" th:action="@{/agregarDireccionCliente}" method="post">
                    <input th:field="*{calle}" placeholder="Calle" id="calleDireccionCliente" required />
                    <input th:field="*{numero}" placeholder="Número" id="numeroDireccionCliente" required />
                    <input th:field="*{codigopostal}" placeholder="Código postal" id="codigoPostalCliente" required />

                    <select th:field="*{localidad}" id="localidadCliente" required>
                        <option value="" disabled selected>Seleccione la localidad</option>
                    </select>

                    <select th:field="*{provincia}" id="provinciaDireccionCliente" required>
                        <option value="" disabled selected>Seleccione la provincia</option>
                    </select>

                    <button type="submit">Registrar Cliente</button>
                </form>
            </div>
        </div>
        <div class="form-container telefono-container">
            <form th:object="${telefonoCliente}" th:action="@{/agregarTelefonoCliente}" method="post">
                <div>
                    <select th:field="*{tipo}" id="tipoTelefono" required>
                        <option value="" disabled selected>Seleccione la provincia</option>
                        <option th:each="prov : ${tipoTelefono}" th:value="${prov}" th:text="${prov}"></option>
                    </select>
                </div>
                <div>
                    <input th:field="*{numero}" placeholder="Número" id="numeroCliente" required />
                </div>
                <div>
                    <button type="submit">Registrar teléfono</button>
                </div>
            </form>
        </div>
    </div>
    <!-- //copyright -->
    <ul class="colorlib-bubbles">
        <li></li>
        <li></li>
        <li></li>
        <li></li>
        <li></li>
        <li></li>
        <li></li>
        <li></li>
        <li></li>
        <li></li>
    </ul>
</div>
<!-- //main -->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const codigoPostalInput = document.getElementById("codigoPostalCliente");
        const localidadSelect = document.getElementById("localidadCliente");
        const provinciaSelect = document.getElementById("provinciaDireccionCliente");

        codigoPostalInput.addEventListener("input", function () {
            const codigoPostal = codigoPostalInput.value.trim(); // Asegúrate de que no haya espacios en blanco

            if (codigoPostal.length > 0) {
                fetch(`/filtrarCodigoPostal?codigoPostal=${codigoPostal}`, {
                    method: "GET",
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error("Error en la respuesta del servidor");
                        }
                        return response.json(); // Suponiendo que el controlador devuelve JSON
                    })
                    .then(data => {
                        if (data.codigosPostales) {
                            // Limpiar selects actuales
                            limpiarSelect(localidadSelect, "Seleccione la localidad");
                            limpiarSelect(provinciaSelect, "Seleccione la provincia");

                            // Actualizar opciones
                            const localidades = new Set(); // Usamos un Set para evitar duplicados
                            const provincias = new Set();

                            data.codigosPostales.forEach(cp => {
                                localidades.add(cp.localidad);
                                provincias.add(cp.provincia);
                            });

                            // Añadir opciones únicas al select de localidad
                            localidades.forEach(localidad => {
                                const localidadOption = document.createElement("option");
                                localidadOption.value = localidad;
                                localidadOption.textContent = localidad;
                                localidadSelect.appendChild(localidadOption);
                            });

                            // Añadir opciones únicas al select de provincia
                            provincias.forEach(provincia => {
                                const provinciaOption = document.createElement("option");
                                provinciaOption.value = provincia;
                                provinciaOption.textContent = provincia;
                                provinciaSelect.appendChild(provinciaOption);
                            });
                        } else {
                            console.error("No se encontraron coincidencias");
                        }
                    })
                    .catch(error => {
                        console.error("Error al filtrar el código postal:", error);
                    });
            }
        });

        // Función para limpiar un select y añadir una opción por defecto
        function limpiarSelect(selectElement, defaultText) {
            selectElement.innerHTML = ''; // Limpia todas las opciones
            const defaultOption = document.createElement("option");
            defaultOption.value = '';
            defaultOption.disabled = true;
            defaultOption.selected = true;
            defaultOption.textContent = defaultText;
            selectElement.appendChild(defaultOption);
        }
    });
</script>
</body>
</html>